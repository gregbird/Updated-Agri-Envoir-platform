<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dulra Agri Environmental Management Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar {
            width: 250px;
        }

        .main-content {
            width: calc(100% - 250px);
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Simple transition effects */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }

        .list-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-left-color: #16a34a;
            /* green-600 */
        }
    </style>
</head>

<body class="bg-gray-100">

    <div id="login-page" class="hidden min-h-screen bg-gray-100 flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg border border-gray-200">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-green-700">Dulra Management Platform</h1>
                <p class="text-gray-500 mt-2">Welcome back, please log in.</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                    <input type="email" id="email" value="helen@dulra.ie"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                        required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" value="password"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                        required>
                </div>
                <div class="flex items-center justify-between mb-6 text-sm">
                    <label class="flex items-center text-gray-600">
                        <input type="checkbox" class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                        <span class="ml-2">Remember me</span>
                    </label>
                    <a href="#" class="font-medium text-green-600 hover:text-green-500">Forgot your password?</a>
                </div>
                <button type="submit"
                    class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-all">
                    Log In
                </button>
            </form>
        </div>
    </div>

    <div id="app" class="">
        <div
            class="sidebar fixed top-0 left-0 h-screen bg-white shadow-md flex flex-col border-r border-gray-200 z-10">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-green-700">Dulra</h1>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="#" id="home-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-home w-6 text-center"></i>
                    <span class="ml-4 font-semibold">Home</span>
                </a>
                <a href="#" id="dashboard-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-chart-line w-6 text-center"></i>
                    <span class="ml-4 font-semibold">Dashboard</span>
                </a>
                <a href="#" id="tasks-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-tasks w-6 text-center"></i>
                    <span class="ml-4 font-semibold">Tasks</span>
                </a>
                <a href="#" id="plans-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-map-marked-alt w-6 text-center"></i>
                    <span class="ml-4 font-semibold">Plans</span>
                </a>

                <div class="pt-2">
                    <h3 class="px-3 text-xs uppercase text-gray-400 font-semibold mb-2">Management</h3>
                    <a href="#" id="surveys-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                        <div class="flex items-center">
                            <i class="fas fa-poll w-6 text-center"></i>
                            <span class="ml-4 font-semibold">Surveys</span>
                        </div>
                    </a>
                    <a href="#" id="communication-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                        <div class="flex items-center">
                            <i class="fas fa-bullhorn w-6 text-center"></i>
                            <span class="ml-4 font-semibold">Communication</span>
                        </div>
                    </a>
                    <a href="#" id="audit-trail-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                        <div class="flex items-center">
                            <i class="fas fa-history w-6 text-center"></i>
                            <span class="ml-4 font-semibold">Audit Trail</span>
                        </div>
                    </a>
                </div>

                <div class="pt-2">
                    <h3 class="px-3 text-xs uppercase text-gray-400 font-semibold mb-2">Reports</h3>
                    <div class="pl-4 space-y-2">
                        <button class="collapsible-btn w-full flex justify-between items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                            <span class="font-semibold">Private Funders</span>
                            <i class="fas fa-chevron-down transform transition-transform duration-200 text-xs"></i>
                        </button>
                        <div class="collapsible-content hidden pl-6 space-y-2 text-sm">
                            <a href="#" class="block p-2 hover:bg-gray-200 rounded-md">County</a>
                            <a href="#" class="block p-2 hover:bg-gray-200 rounded-md">ESG Report</a>
                            <a href="#" class="block p-2 hover:bg-gray-200 rounded-md">CSRD Report</a>
                        </div>
                        <button class="collapsible-btn w-full flex justify-between items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg text-left">
                            <span class="font-semibold">Public Funders</span>
                            <i class="fas fa-chevron-down transform transition-transform duration-200 text-xs"></i>
                        </button>
                        <div class="collapsible-content hidden pl-6 space-y-2 text-sm">
                            <a href="#" class="block p-2 hover:bg-gray-200 rounded-md">County</a>
                            <a href="#" class="block p-2 hover:bg-gray-200 rounded-md">EU Restoration Targets</a>
                            <a href="#" class="block p-2 hover:bg-gray-200 rounded-md">EU Habitat Directive</a>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="p-4 border-t border-gray-200">
                <a href="#" id="settings-link" class="flex items-center p-3 text-gray-600 hover:bg-gray-200 rounded-lg mb-2">
                    <i class="fas fa-cog w-6 text-center"></i>
                    <span class="ml-4 font-semibold">Settings</span>
                </a>
                <div class="flex items-center p-2 bg-gray-50 rounded-lg">
                    <img class="h-10 w-10 rounded-full"
                        src="https://images.unsplash.com/photo-1517841905240-472988babdf9?ixlib=rb-1.2.1&auto=format&fit=facearea&w=256&h=256&q=80"
                        alt="User avatar">
                    <div class="ml-3">
                        <p class="text-sm font-semibold text-gray-800">Welcome, Helen!</p>
                        <p class="text-xs text-gray-500">Team Coordinator</p>
                    </div>
                    <button id="logout-btn" class="ml-auto text-gray-500 hover:text-red-600" title="Log Out">
                        <i class="fas fa-sign-out-alt fa-lg"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content ml-[250px]">
            <header class="bg-white p-6 flex justify-between items-center shadow-sm border-b border-gray-200 sticky top-0">
                <h2 id="page-title" class="text-2xl font-bold text-gray-800">Platform Overview</h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input id="search-input" type="text" placeholder="Search landowner..."
                            class="hidden w-64 px-4 py-2 border border-gray-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                        <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button id="add-task-btn"
                        class="hidden bg-blue-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-700 transition-all shadow-md">
                        <i class="fas fa-plus mr-2"></i>Create Task
                    </button>
                    <button id="add-project-btn"
                        class="hidden bg-green-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-700 transition-all shadow-md">
                        <i class="fas fa-plus mr-2"></i>New Participant
                    </button>
                </div>
            </header>
            
            <main id="content-area" class="p-8">
                </main>
        </div>

        <div id="new-project-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden"></div>
        <div id="assessment-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden"></div>
        <div id="survey-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden"></div>
        <div id="communication-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden"></div>
        <div id="new-task-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden"></div>
        
        <div id="toast-notification"
            class="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center transition-all duration-300 opacity-0 -translate-y-10 z-50">
            <i class="fas fa-check-circle mr-3"></i>
            <p class="font-semibold">Message sent successfully!</p>
        </div>
    </div>


    <script>
// --- DATA STORE --- // Mock database for the MVP
const surveyTemplates = [
    {
        id: 1, name: 'Application', description: 'Initial application form for landowners.', questionCount: 8, icon: 'fa-folder-plus',
        questions: [
            { type: 'text', label: 'Landowner Name' },
            { type: 'text', label: 'Herd Number' },
            { type: 'text', label: 'Eircode' },
            { type: 'tel', label: 'Phone Number' },
            { type: 'radio', label: 'Are you in OFS3?', options: ['Yes', 'No'] },
        ]
    },
    {
        id: 2, name: 'Scorecard for Peatlands', description: 'Feedback survey for the ecological plan service.', questionCount: 6, icon: 'fa-feather-alt',
        questions: [
            { type: 'number', label: 'A1: Water Level (Score 0-10)' },
            { type: 'number', label: 'A2: Sphagnum Cover (Score 0-10)' },
            { type: 'number', label: 'B1: Vegetation Structure (Score 0-10)' },
            { type: 'number', label: 'C1: Grazing Impact (Score 0-10)' },
        ]
    },
    {
        id: 3, name: 'Scorecard for Grasslands', description: 'Pre-implementation questions for pond projects.', questionCount: 7, icon: 'fa-water',
        questions: [
            { type: 'number', label: 'A1: Species Diversity (Score 0-10)' },
            { type: 'number', label: 'B1: Sward Height (Score 0-10)' },
            { type: 'number', label: 'C1: Soil Compaction (Score 0-10)' },
        ]
    },
    {
        id: 4, name: 'Post Project Survey', description: 'General feedback survey for completed projects.', questionCount: 5, icon: 'fa-award',
        questions: [
            { type: 'radio', label: 'How satisfied are you?', options: ['Very', 'Neutral', 'Not'] },
            { type: 'textarea', label: 'Any feedback?' },
        ]
    },
    {
        id: 5, name: 'Scorecard for Woodland', description: 'Detailed on-site assessment.', questionCount: 15, icon: 'fa-vial',
        questions: [
            { type: 'text', label: 'HC Participant' },
            { type: 'date', label: 'Date of Visit' },
            { type: 'text', label: 'Eircode' },
            { type: 'text', label: 'Surveyor' },
            { type: 'tel', label: 'Phone Number' },
            { type: 'radio', label: 'Fixed Point Photo taken?', options: ['Yes', 'No'] },
            { type: 'number', label: 'Size (m2)' },
            { type: 'radio', label: 'Holding Water?', options: ['Yes', 'No'] },
            { type: 'text', label: 'If no, is it Ephemeral or has it failed?' },
            { type: 'radio', label: 'Plants', options: ['All native', 'Some non-native', 'Some invasive'] },
            { type: 'textarea', label: 'Insects present during visit?\nIf yes, which?' },
            { type: 'textarea', label: 'Were you happy with the pond site visit? Was enough info given?' },
            { type: 'radio', label: 'Did you utilise the resources (webinar, pond notes)?', options: ['Yes', 'No'] },
            { type: 'radio', label: 'Are you happy with the way your pond has turned out?', options: ['Yes', 'No'] },
            { type: 'checkbox', label: 'Most Important to you:', options: ['Money', 'Pond Advisor', 'Resources'] }
        ]
    },
    {
        id: 6, name: 'Woodland Assessment', description: 'On-site assessment for mini woodland projects.', questionCount: 9, icon: 'fa-tree',
        questions: [
            { type: 'text', label: 'HC Participant' },
            { type: 'date', label: 'Date of Visit' },
            { type: 'text', label: 'Eircode & Phone' },
            { type: 'text', label: 'Surveyor' },
            { type: 'number', label: 'Companion Species: % survival rating' },
            { type: 'number', label: 'Burren Pine: % survival rating' },
            { type: 'checkbox', label: 'Additional inputs:', options: ['Stakes', 'Fencing', 'Tree Guards', 'Other'] },
            { type: 'checkbox', label: 'Management:', options: ['Trampling', 'Mowing', 'Mulching', 'Spraying', 'None', 'Other'] },
            { type: 'textarea', label: 'Additional Comments?' }
        ]
    },
    {
        id: 7, name: 'Ecological Impact Assessment', description: 'Detailed on-site assessment for projects.', questionCount: 12, icon: 'fa-water',
        questions: [
            { type: 'text', label: 'HC Participant' },
            { type: 'date', label: 'Date of Visit' },
            { type: 'text', label: 'Eircode' },
            { type: 'text', label: 'Surveyor' },
            { type: 'radio', label: 'Fixed Point Photo taken?', options: ['Yes', 'No'] },
            { type: 'number', label: 'Area Surveyed (m2)' },
            { type: 'text', label: 'Primary Habitat Type', placeholder: 'e.g., Dune system, Salt marsh' },
            { type: 'checkbox', label: 'Pressures Observed', options: ['Coastal Erosion', 'Invasive Species (e.g., Sea Buckthorn)', 'Pollution', 'Recreation Impact', 'None'] },
            { type: 'textarea', label: 'Invasive Species Details' },
            { type: 'radio', label: 'Overall Condition', options: ['Good', 'Moderate', 'Poor'] },
            { type: 'textarea', label: 'Management Recommendations' },
            { type: 'textarea', label: 'Additional Comments?' }
        ]
    }
];

const teamMembers = [
    { id: 1, name: 'Peter Jones', role: 'Farm Advisor', email: 'peter.jones@dulra.ie', phone: '353871112233', assignments: [{ projectId: 1, status: 'Pending' }, { projectId: 4, status: 'Waiting for Information' }, { projectId: 15, status: 'Completed' }, { projectId: 22, status: 'Pending' }] },
    { id: 2, name: 'Maria Garcia', role: 'Farm Advisor', email: 'maria.garcia@dulra.ie', phone: '353872223344', assignments: [{ projectId: 2, status: 'Completed' }, { projectId: 8, status: 'Pending' }, { projectId: 18, status: 'Completed' }] },
    { id: 3, name: 'John Doe', role: 'Farm Advisor', email: 'john.doe@dulra.ie', phone: '353873334455', assignments: [{ projectId: 3, status: 'Completed' }, { projectId: 11, status: 'Waiting for Information' }] },
    { id: 4, name: 'Aoife Murphy', role: 'Farm Advisor', email: 'aoife.murphy@dulra.ie', phone: '353864445566', assignments: [{ projectId: 5, status: 'Pending' }, { projectId: 14, status: 'Pending' }] },
    { id: 5, name: 'Cian O\'Kelly', role: 'Farm Advisor', email: 'cian.okelly@dulra.ie', phone: '353855556677', assignments: [{ projectId: 6, status: 'Completed' }, { projectId: 25, status: 'Waiting for Information' }] },
    { id: 6, name: 'Sinead Walsh', role: 'Farm Advisor', email: 'sinead.walsh@dulra.ie', phone: '353876667788', assignments: [{ projectId: 7, status: 'Pending' }, { projectId: 17, status: 'Completed' }] },
    { id: 7, name: 'Eoin Lynch', role: 'Farm Advisor', email: 'eoin.lynch@dulra.ie', phone: '353877778899', assignments: [{ projectId: 9, status: 'Completed' }, { projectId: 28, status: 'Pending' }] },
    { id: 8, name: 'Fionnuala Ryan', role: 'Farm Advisor', email: 'fionnuala.ryan@dulra.ie', phone: '353868889900', assignments: [{ projectId: 10, status: 'Waiting for Information' }, { projectId: 31, status: 'Completed' }] },
    { id: 9, name: 'Declan Byrne', role: 'Farm Advisor', email: 'declan.byrne@dulra.ie', phone: '353859990011', assignments: [{ projectId: 12, status: 'Pending' }, { projectId: 20, status: 'Completed' }] },
    { id: 10, name: 'Roisin Doyle', role: 'Farm Advisor', email: 'roisin.doyle@dulra.ie', phone: '353870001122', assignments: [{ projectId: 13, status: 'Completed' }, { projectId: 24, status: 'Pending' }] }
];

// New Master Action List
const masterActionList = [
    { name: 'Barn Owl nest box', rate: '€36.48/unit/yr' },
    { name: 'Brassica fodder stubble', rate: '€120/ha/yr' },
    { name: 'Catch crops', rate: '€173.20/ha/yr' },
    { name: 'Commonage (results-based)', rate: 'up to €220/ha' },
    { name: 'Conservation of rare breeds', rate: '€200/LU/yr' },
    { name: 'Coppicing of hedgerows', rate: '€2.87/m/yr' },
    { name: 'Environmental management of arable fallow', rate: '€1,047/ha/yr' },
    { name: 'Extensively grazed pasture', rate: '€250/ha/yr' },
    { name: 'Geese and swans', rate: '€205/ha/yr' },
    { name: 'Grass margins - Arable', rate: '€0.76/m/yr (avg)' },
    { name: 'Grass margins - Grassland', rate: '€1.10/m/yr (avg)' },
    { name: 'Laying of hedgerows', rate: '€5.47/m/yr' },
    { name: 'Low emissions slurry spreading', rate: '€1.20/m³/yr' },
    { name: 'Low input grassland (results-based)', rate: 'up to €400/ha/yr' },
    { name: 'Low Input peat grassland (results-based)', rate: 'up to €400/ha/yr' },
    { name: 'Management of intensive grassland next to a watercourse', rate: '€502/ha/yr' },
    { name: 'Minimum tillage', rate: '€40/ha/yr' },
    { name: 'Over winter stubble', rate: '€86/ha/yr' },
    { name: 'Planting a new hedgerow', rate: '€5.29/m/yr' },
    { name: 'Planting a traditional orchard', rate: '€27.49/tree/yr' },
    { name: 'Planting trees in riparian buffer zones', rate: '€3.18/tree/yr' },
    { name: 'Protection and maintenance of archaeological monuments - Arable', rate: '€209/unit/yr' },
    { name: 'Protection and maintenance of archaeological monuments - Grassland', rate: '€125/unit/yr' },
    { name: 'Riparian buffer strip – Arable', rate: '€0.77/m/yr (avg)' },
    { name: 'Riparian buffer strip – Grassland', rate: '€1.71/m/yr (avg)' },
    { name: 'Riparian buffer zone – Arable', rate: '€1,242/ha/yr' },
    { name: 'Riparian buffer zone – Grassland', rate: '€1,530/ha/yr' },
    { name: 'Ryegrass seed-set as winter food for birds', rate: '€1.37/m/yr' },
    { name: 'Traditional dry stone wall maintenance', rate: '€0.76/m/yr' },
    { name: 'Tree belts for ammonia capture from farmyards', rate: '€5,028/ha/yr' },
    { name: 'Tree planting', rate: '€6.21/tree/yr' },
    { name: 'Unharvested cereal headlands', rate: '€2.52/m/yr (avg)' },
    { name: 'Winter bird food plot', rate: '€1,000/ha/yr' },
    { name: 'Winter bird food strip', rate: '€0.98/m/yr (avg)' }
];
const actionStatuses = ['Authorised', 'Completed', 'Paid'];

// New Global Audit Log
let globalAuditLog = [
    { landowner: 'David Miller', change: 'On-site assessment completed by John Doe.', date: '2025-09-18', time: '14:30', teamMember: 'John Doe' },
    { landowner: 'Sarah Chen', change: 'Project initiated.', date: '2025-09-17', time: '11:00', teamMember: 'Helen (Team Coordinator)' },
    { landowner: 'System', change: "Scorecard 'Scorecard for Peatlands' structure approved.", date: '2025-09-17', time: '09:15', teamMember: 'Helen (Team Coordinator)' },
    { landowner: 'Tom O\'Sullivan', change: "Action 'Planting a new hedgerow' status changed to 'Completed'.", date: '2025-09-16', time: '16:05', teamMember: 'Maria Garcia' },
    { landowner: 'Tom O\'Sullivan', change: "Payment status for 'Grassland' (2023) set to 'Paid'.", date: '2025-09-16', time: '16:00', teamMember: 'Helen (Team Coordinator)' },
];

// New Global Task List
let globalTaskList = [
    { id: 1, name: 'GIS Data Sourcing', landowner: 'David Miller', teamMember: 'Peter Jones', due: '2025-10-01', status: 'Completed' },
    { id: 2, name: 'On-site Habitat Assessment', landowner: 'David Miller', teamMember: 'Peter Jones', due: '2025-10-05', status: 'In Progress' },
    { id: 3, name: 'Initial Landowner Consultation', landowner: 'Sarah Chen', teamMember: 'Maria Garcia', due: '2025-10-02', status: 'Completed' },
    { id: 4, name: 'Draft Farm Plan', landowner: 'Sarah Chen', teamMember: 'Maria Garcia', due: '2025-10-10', status: 'Pending' },
    { id: 5, name: 'Scorecard Survey: Grasslands', landowner: 'Tom O\'Sullivan', teamMember: 'John Doe', due: '2025-09-30', status: 'Completed' },
    { id: 6, name: 'GIS Data Sourcing', landowner: 'Grace Kelly', teamMember: 'Peter Jones', due: '2025-10-15', status: 'Pending' },
    { id: 7, name: 'On-site Habitat Assessment', landowner: 'Liam Murphy', teamMember: 'Maria Garcia', due: '2025-10-12', status: 'In Progress' },
];

// Helper to generate 100+ audit logs
function generateMockAuditLogs() {
    const logTypes = ['Site visit for', 'Survey landowner', 'Draft plan for', 'GIS Data Sourcing for', 'Payment approved for', 'Action status changed for'];
    const landowners = ['Liam Murphy', 'Olivia Kelly', 'Noah Byrne', 'Emma Ryan', 'Oliver O\'Brien', 'Ava Walsh', 'Elijah O\'Connor', 'Charlotte Doyle'];
    const members = teamMembers.map(m => m.name);
    for (let i = 0; i < 100; i++) {
        const date = new Date(new Date().getTime() - Math.random() * 30 * 24 * 60 * 60 * 1000); // Random date in last 30 days
        globalAuditLog.push({
            landowner: landowners[Math.floor(Math.random() * landowners.length)],
            change: `${logTypes[Math.floor(Math.random() * logTypes.length)]} ${landowners[Math.floor(Math.random() * landowners.length)]}.`,
            date: date.toISOString().slice(0, 10),
            time: date.toLocaleTimeString('en-IE', { hour: '2-digit', minute: '2-digit' }),
            teamMember: members[Math.floor(Math.random() * members.length)]
        });
    }
    // Sort by date descending
    globalAuditLog.sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
}

// Helper function to generate realistic project data
function generateProjects() {
    const firstNames = ['Liam', 'Olivia', 'Noah', 'Emma', 'Oliver', 'Ava', 'Elijah', 'Charlotte', 'William', 'Sophia', 'James', 'Amelia', 'Benjamin', 'Isabella', 'Lucas', 'Mia'];
    const lastNames = ['Murphy', 'Kelly', 'Byrne', 'Ryan', 'O\'Brien', 'Walsh', 'O\'Connor', 'Doyle', 'McCarthy', 'Gallagher', 'Lynch', 'Murray'];
    const counties = ['Kerry', 'Cork', 'Galway', 'Clare', 'Limerick', 'Tipperary', 'Mayo', 'Donegal'];
    // Updated Action Types
    const actionTypes = ['Fencing', 'Blocking Drains', 'Woodland', 'Sphagnum Moss', 'Hedgerow'];
    
    // Habitat data
    const allHabitats = ['Grassland', 'Peatland', 'Scrub/Woodland', 'Coastal', 'Rough Grazing', 'Breeding Wader', 'Corncrake', 'Chough'];
    const paymentStatuses = ['Paid', 'Authorisation', 'Pending'];
    const planActionStatuses = ['Authorisation', 'Pending', 'Completed'];

    // Helper to get random subset
    const getRandomSubset = (arr, n) => arr.sort(() => 0.5 - Math.random()).slice(0, n);

    // Helper to generate scores
    const generateScores = () => {
        const scores = [];
        let baseScore = Math.random() * 3 + 2; // Start score between 2-5
        for (let i = 0; i < 3; i++) {
            const year = 2023 + i;
            const a = Math.floor(Math.random() * 10);
            const b = Math.floor(Math.random() * 10);
            const c = Math.floor(Math.random() * 10);
            // Ensure upward trend
            const overall = Math.min(10, Math.max(0, baseScore + Math.random() * 2));
            baseScore = overall + Math.random(); // Next year starts a bit higher

            scores.push({
                year: year,
                A_Integrity: a,
                B_Structure: b,
                C_Management: c,
                Overall_Score: parseFloat(overall.toFixed(1)),
                paymentStatus: paymentStatuses[i],
                paymentAmount: 0 // Will be calculated later
            });
        }
        return scores;
    };

    let projectList = [
        // Keep original diverse-status projects for context - UPDATED with new action types
        {
            id: 1, landowner: 'David Miller', county: 'Kerry', eircode: 'V93 AB12', phone: '353871234567', actionType: 'Blocking Drains', status: 'Implementation', startDate: '2025-08-15', specialist: 'Peter Jones', details: 'Blocking drains in the lower meadow to enhance local biodiversity and re-wet the area.', assessments: [], survey: { status: 'Pending', data: null }, activityLog: [{ date: '2025-08-20', activity: 'Farm Advisor assigned: Peter Jones' }, { date: '2025-08-15', activity: 'Application approved. Project initiated.' }],
            herdNumber: '1234567', parcelLabel: 'KY-101-A', digitisedArea: '10.5', maxEligibleArea: '10.2'
        },
        {
            id: 2, landowner: 'Sarah Chen', county: 'Cork', eircode: 'T23 CD34', phone: '353872345678', actionType: 'Woodland', status: 'Data Collection', startDate: '2025-07-01', specialist: 'Maria Garcia', details: 'A comprehensive ecological plan for a new 10-acre mixed woodland.', assessments: [{ assessor: 'Maria Garcia', date: '2025-09-10', notes: 'Site visit complete. Excellent potential for native species reintroduction. Soil samples taken.', photos: 2, location: '52.05, -9.51' }], survey: { status: 'Pending', data: null }, activityLog: [{ date: '2025-09-10', activity: 'On-site assessment completed by Maria Garcia.' }, { date: '2025-07-05', activity: 'Ecologist created 10-page plan and delivered to landowner.' }, { date: '2025-07-01', activity: 'Project initiated.' }],
            herdNumber: '2345678', parcelLabel: 'CK-202-B', digitisedArea: '8.2', maxEligibleArea: '8.0'
        },
        {
            id: 3, landowner: 'Tom O\'Sullivan', county: 'Limerick', eircode: 'V94 EF56', phone: '353873456789', actionType: 'Hedgerow', status: 'Complete', startDate: '2025-04-10', specialist: 'John Doe', details: 'Planting of 300m of native Irish hedgerow.', assessments: [{ assessor: 'John Doe', date: '2025-09-18', notes: 'Post-action assessment shows 95% plant survival rate. Good growth observed.', photos: 5, location: '52.14, -9.52' }], survey: { status: 'Complete', data: { satisfaction: 5, feedback: 'The process was smooth and the advice was very helpful!' } }, activityLog: [{ date: '2025-09-20', activity: 'Participant survey completed.' }, { date: '2025-09-18', activity: 'On-site assessment completed by John Doe.' }, { date: '2025-04-22', activity: 'Landowner planted hedgerow.' }, { date: '2025-04-10', activity: 'Project initiated.' }],
            herdNumber: '3456789', parcelLabel: 'LK-303-C', digitisedArea: '5.0', maxEligibleArea: '5.0'
        },
        {
            id: 4, landowner: 'Grace Kelly', county: 'Clare', eircode: 'V95 GH78', phone: '353874567890', actionType: 'Fencing', status: 'Application Review', startDate: '2025-09-21', specialist: 'N/A', details: 'Proposal for fencing off a small pond near an existing stream.', assessments: [], survey: { status: 'Not Sent', data: null }, activityLog: [{ date: '2025-09-21', activity: 'Landowner submitted application.' }],
            herdNumber: '4567890', parcelLabel: 'CE-404-D', digitisedArea: '1.5', maxEligibleArea: '1.5'
        }
    ];

    const eircodePrefixes = { 'Kerry': 'V93', 'Cork': 'T23', 'Galway': 'H91', 'Clare': 'V95', 'Limerick': 'V94', 'Tipperary': 'E41', 'Mayo': 'F23', 'Donegal': 'F92' };
    const chars = 'ABCDEFHKNPRSTVWXYZ123456789';
    const specialistNames = teamMembers.map(t => t.name);

    for (let i = 5; i <= 34; i++) {
        const fName = firstNames[Math.floor(Math.random() * firstNames.length)];
        const lName = lastNames[Math.floor(Math.random() * lastNames.length)];
        const county = counties[Math.floor(Math.random() * counties.length)];
        const action = actionTypes[Math.floor(Math.random() * actionTypes.length)];
        const month = Math.floor(Math.random() * 8) + 1; // Jan to Aug
        
        let randomEircode = eircodePrefixes[county] + ' ';
        for (let j = 0; j < 4; j++) randomEircode += chars.charAt(Math.floor(Math.random() * chars.length));
        const digiArea = (Math.random() * 20 + 1).toFixed(1);
        const mea = (digiArea - (Math.random() * 2)).toFixed(1);

        projectList.push({
            id: i,
            landowner: `${fName} ${lName}`,
            county: county,
            eircode: randomEircode,
            phone: `35386${Math.floor(1000000 + Math.random() * 9000000)}`,
            actionType: action,
            status: 'Implementation',
            startDate: `2025-0${month}-${Math.floor(Math.random() * 28) + 1}`,
            specialist: specialistNames[Math.floor(Math.random() * specialistNames.length)],
            details: `Project in implementation phase for ${action.toLowerCase()}.`,
            assessments: [],
            survey: { status: 'Not Sent', data: null },
            activityLog: [
                { date: `2025-0${month}-01`, activity: 'Application approved. Project initiated.' }
            ],
            herdNumber: Math.floor(1000000 + Math.random() * 9000000).toString(),
            parcelLabel: `${eircodePrefixes[county]}-${Math.floor(100 + Math.random() * 900)}-${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`,
            digitisedArea: digiArea,
            maxEligibleArea: mea < 0 ? digiArea : mea
        });
    }
    
    // Add new data models to all projects
    projectList.forEach(p => {
        // Add Habitats & Scores
        p.habitats = getRandomSubset(allHabitats, 3).map(name => ({
            name: name,
            scores: generateScores()
        }));
        
        // Add Payment Info
        p.isOFS3 = Math.random() < 0.3; // 30% of farmers are in OFS3
        p.habitats.forEach(h => {
            h.scores.forEach(s => {
                s.paymentAmount = calculatePaymentRate(s.Overall_Score, p.isOFS3);
            });
        });

        // Add AECM Actions
        p.actions = getRandomSubset(masterActionList, Math.floor(Math.random() * 3) + 4).map(action => ({
            name: action.name,
            rate: action.rate,
            quantity: `${Math.floor(Math.random() * 10) + 1} ${action.rate.includes('/ha/') ? 'ha' : (action.rate.includes('/m/') ? 'm' : 'units')}`,
            status: actionStatuses[Math.floor(Math.random() * actionStatuses.length)]
        }));
        
        // Add Plan Data
        p.partnershipNumber = Math.floor(10000000 + Math.random() * 90000000).toString();
        p.recommendedActions = getRandomSubset(masterActionList, Math.floor(Math.random() * 2) + 3).map(action => ({
            name: action.name,
            status: planActionStatuses[Math.floor(Math.random() * planActionStatuses.length)]
        }));
        p.planNotes = "Initial site walk complete. Landowner is very engaged, particularly with riparian zones. Follow-up required for soil samples.";
        p.farmerComments = "Very happy with the plan. Eager to start on the hedgerow planting but concerned about the cost of fencing.";
    });
    
    // Add new tasks for team members
    const taskTypes = ['Survey landowner', 'Site visit for', 'Draft plan for', 'GIS Data Sourcing for'];
    const taskLandowners = projectList.slice(4).map(p => p.landowner); // Use generated landowners
    
    teamMembers.forEach(member => {
        // Add 2 tasks to each member
        for(let i=0; i<2; i++) {
            globalTaskList.push({
                id: globalTaskList.length + 1,
                name: `${taskTypes[Math.floor(Math.random() * taskTypes.length)]}`,
                landowner: taskLandowners[Math.floor(Math.random() * taskLandowners.length)],
                teamMember: member.name,
                due: `2025-11-${Math.floor(Math.random() * 10) + 20}`, // Due in next 10 days
                status: Math.random() > 0.5 ? 'Pending' : 'In Progress'
            });
        }
    });

    return projectList;
}

// New Payment Calculation Function
function calculatePaymentRate(score, isOFS3) {
    const s = Math.round(score); // Round to nearest integer for lookup
    if (isOFS3) {
        if (s === 10) return 150;
        if (s === 9) return 100;
        if (s === 8) return 50;
        return 0; // 7 and below is 0
    } else {
        if (s === 10) return 400;
        if (s === 9) return 350;
        if (s === 8) return 300;
        if (s === 7) return 250;
        if (s === 6) return 205;
        if (s === 5) return 175;
        if (s === 4) return 150;
        return 0; // Below 4 is 0
    }
}


let projects = generateProjects();
// Global object to hold chart instances
let chartInstances = {};

// --- GLOBAL STATE ---
const state = {
    currentView: 'overview', // 'overview', 'dashboard', 'projectDetail', 'team', 'surveys', 'plansList', 'planDetail', 'auditTrail', 'settings'
    dashboardView: 'analytics', // 'list' or 'analytics' - Defaulted to analytics
    currentProjectId: null,
    currentPlanView: 'list', // 'list' or 'detail'
    currentProjectDetailTab: 'detail', // 'detail', 'habitats', 'actions', 'payments', 'plan'
    currentSettingsTab: 'general', // 'general', 'users'
    currentSurveyTemplateId: null, // For editor
    filterText: '',
};

// --- DOM ELEMENTS ---
const contentArea = document.getElementById('content-area');
const pageTitle = document.getElementById('page-title');
const searchInput = document.getElementById('search-input');
const homeLink = document.getElementById('home-link');
const dashboardLink = document.getElementById('dashboard-link');
const addProjectBtn = document.getElementById('add-project-btn');
const surveysLink = document.getElementById('surveys-link');
const communicationLink = document.getElementById('communication-link');
const teamLink = document.getElementById('team-link');
// New links
const tasksLink = document.getElementById('tasks-link');
const plansLink = document.getElementById
('plans-link');
const auditTrailLink = document.getElementById('audit-trail-link');
const settingsLink = document.getElementById('settings-link');
const addTaskBtn = document.getElementById('add-task-btn');

// login/app elements
const loginPage = document.getElementById('login-page');
const appContainer = document.getElementById('app');
const loginForm = document.getElementById('login-form');
const logoutBtn = document.getElementById('logout-btn');

// --- STATUS STYLES MAPPING ---
const statusStyles = {
    'Application Review': 'bg-yellow-100 text-yellow-800',
    'Implementation': 'bg-blue-100 text-blue-800',
    'Data Collection': 'bg-purple-100 text-purple-800',
    'Complete': 'bg-green-100 text-green-800',
};
const assignmentStatusStyles = {
    'Waiting for Information': 'bg-yellow-100 text-yellow-800',
    'Pending': 'bg-blue-100 text-blue-800',
    'Completed': 'bg-green-100 text-green-800',
    'In Progress': 'bg-purple-100 text-purple-800'
};
// New AECM Action Styles
const actionStatusStyles = {
    'Authorised': 'bg-blue-100 text-blue-800',
    'Completed': 'bg-green-100 text-green-800',
    'Paid': 'bg-purple-100 text-purple-800',
    'Pending': 'bg-yellow-100 text-yellow-800'
};
const paymentStatusStyles = {
    'Paid': 'bg-green-100 text-green-800',
    'Authorisation': 'bg-blue-100 text-blue-800',
    'Pending': 'bg-yellow-100 text-yellow-800'
};
const planActionStatusStyles = {
    'Authorisation': 'bg-blue-100 text-blue-800',
    'Completed': 'bg-green-100 text-green-800',
    'Pending': 'bg-yellow-100 text-yellow-800'
};

const iconMap = {
    'Fencing': 'fas fa-grip-horizontal',
    'Blocking Drains': 'fas fa-trowel',
    'Woodland': 'fas fa-tree',
    'Sphagnum Moss': 'fas fa-seedling',
    'Hedgerow': 'fas fa-leaf',
    // Old icons left for survey templates
    'Wildlife Pond': 'fas fa-water',
    'Plan for Nature': 'fas fa-feather-alt',
    'Mini Woodland': 'fas fa-tree',
};

// --- RENDER FUNCTIONS ---
/**
 * Sets the active link in the sidebar
 */
function setActiveLink(activeLink) {
    // Remove active styles from all main links
    [homeLink, dashboardLink, tasksLink, plansLink, surveysLink, communicationLink, teamLink, auditTrailLink, settingsLink].forEach(link => {
        if (link) { // Check if link exists
            link.classList.remove('bg-green-100', 'text-green-800', 'font-semibold');
            link.classList.add('text-gray-600', 'hover:bg-gray-200');
        }
    });
    // Add active styles to the target link
    if (activeLink) {
        activeLink.classList.add('bg-green-100', 'text-green-800', 'font-semibold');
        activeLink.classList.remove('text-gray-600', 'hover:bg-gray-200');
    }
}

/**
 * Renders the main overview/home page.
 */
function renderOverviewPage() {
    state.currentView = 'overview';
    state.currentProjectId = null;
    pageTitle.textContent = 'Platform Overview';
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    searchInput.classList.add('hidden');
    setActiveLink(homeLink);
    contentArea.innerHTML = `
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">The Dulra Agri Environmental Management Platform</h2>
            <p class="text-lg text-gray-600 mb-8">A comprehensive solution designed to bring efficiency and scalability to your environmental projects. This platform is built on six core modules:</p>
            <div class="space-y-8">
                <div class="flex items-start">
                    <i class="fas fa-user-plus fa-2x text-green-600 w-12 text-center mt-1"></i>
                    <div class="ml-4 flex-1">
                        <h3 class="text-xl font-semibold mb-1">1. Participant Onboarding & Management</h3>
                        <p class="text-gray-600 mb-2">Automate the sign-up process from the start.</p>
                        <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                            <li><strong>Configurable Sign-Up Forms:</strong> Participants apply and submit data through a guided digital form.</li>
                            <li><strong>Backend Approval System:</strong> Your team can approve or tag participants based on pre-set criteria.</li>
                            <li><strong>Application Progress Notifications:</strong> Automatic updates keep participants informed.</li>
                        </ul>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-tasks fa-2x text-green-600 w-12 text-center mt-1"></i>
                    <div class="ml-4 flex-1">
                        <h3 class="text-xl font-semibold mb-1">2. Workflow Management</h3>
                        <p class="text-gray-600 mb-2">Get a real-time, comprehensive view of your entire operation.</p>
                        <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                            <li><strong>Real-Time Dashboard:</strong> Shows the live status, key metrics, and progress of all projects.</li>
                            <li><strong>Customizable Workflows:</strong> Organise surveys, actions, and assign team members.</li>
                            <li><strong>Workload Visibility:</strong> Views show the current workload and capacity of individual team members.</li>
                        </ul>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-database fa-2x text-green-600 w-12 text-center mt-1"></i>
                    <div class="ml-4 flex-1">
                        <h3 class="text-xl font-semibold mb-1">3. Data Management</h3>
                        <p class="text-gray-600 mb-2">Efficient data collection, verification, and storage for all field activities.</p>
                        <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                            <li><strong>Digital Data Collection:</strong> Create, manage, and deploy digital surveys and on-site assessment forms from a phone or tablet.</li>
                            <li><strong>Eliminate Paperwork:</strong> Data is captured instantly and syncs directly to relevant project files.</li>
                            <li><strong>Monitoring & Audit Trail:</strong> Connect to monitoring tools and maintain an audit trail for all data.</li>
                        </ul>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-chart-pie fa-2x text-green-600 w-12 text-center mt-1"></i>
                    <div class="ml-4 flex-1">
                        <h3 class="text-xl font-semibold mb-1">4. Reporting & Impact Generation</h3>
                        <p class="text-gray-600 mb-2">Turn raw data into professional, stakeholder-ready reports.</p>
                        <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                            <li><strong>Template-Based Reporting:</strong> Instantly generate reports for ESG, CSRD, EU Restoration Targets, etc.</li>
                            <li><strong>Automatic Data Aggregation:</strong> The platform automatically pulls and aggregates data from all modules.</li>
                        </ul>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-bullhorn fa-2x text-green-600 w-12 text-center mt-1"></i>
                    <div class="ml-4 flex-1">
                        <h3 class="text-xl font-semibold mb-1">5. Integrated Communications Suite</h3>
                        <p class="text-gray-600 mb-2">Engage with your participants efficiently and effectively.</p>
                        <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                            <li><strong>Targeted Bulk Messaging:</strong> Send individual or filtered bulk Emails and WhatsApp messages.</li>
                            <li><strong>Filter-Based Sending:</strong> Use filters (like action type or project status) to reach the right people.</li>
                        </ul>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-map-marked-alt fa-2x text-green-600 w-12 text-center mt-1"></i>
                    <div class="ml-4 flex-1">
                        <h3 class="text-xl font-semibold mb-1">6. Project Visualisation (Phase 2)</h3>
                        <p class="text-gray-600 mb-2">Create a public-facing interactive map and key impact dashboard.</p>
                        <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                            <li><strong>Public-Facing Showcase:</strong> Showcase projects to enable stakeholders to explore and assess projects for funding.</li>
                            <li><strong>Provide Context:</strong> Provides geographic and impact context to your projects.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * Renders the main dashboard view (now only analytics).
 */
function renderDashboard() {
    state.currentView = 'dashboard';
    state.currentProjectId = null;
    pageTitle.textContent = 'Projects Dashboard';
    setActiveLink(dashboardLink);
    searchInput.classList.add('hidden');
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    
    // No more tabs, just render analytics directly
    contentArea.innerHTML = `<div id="dashboard-content"></div>`;
    renderAnalyticsDashboard();
}

/**
 * Renders the new Analytics Dashboard view
 */
function renderAnalyticsDashboard() {
    const dashboardContent = document.getElementById('dashboard-content');
    if (!dashboardContent) return;

    // Destroy old charts if they exist
    Object.values(chartInstances).forEach(chart => chart.destroy());
    chartInstances = {};
    
    // --- New Habitat Data Aggregation ---
    const habitatData = {};
    const allHabitats = ['Grassland', 'Peatland', 'Scrub/Woodland', 'Coastal', 'Rough Grazing', 'Breeding Wader', 'Corncrake', 'Chough'];
    allHabitats.forEach(h => {
        habitatData[h] = { '2023': [], '2024': [], '2025': [] };
    });

    projects.forEach(p => {
        p.habitats.forEach(h => {
            if (habitatData[h.name]) {
                h.scores.forEach(s => {
                    habitatData[h.name][s.year].push(s.Overall_Score);
                });
            }
        });
    });

    const getAvg = (arr) => arr.length ? (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1) : 0;

    const habitatChartData = {};
    allHabitats.forEach(h => {
        habitatChartData[h] = {
            labels: ['Baseline (2023)', 'Year 2 (2024)', 'Year 3 (2025)'],
            data: [
                getAvg(habitatData[h]['2023']),
                getAvg(habitatData[h]['2024']),
                getAvg(habitatData[h]['2025'])
            ]
        };
    });
    // --- End of Aggregation ---

    const habitatChartsHTML = allHabitats.map(h => `
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <h3 class="text-lg font-semibold mb-4">${h}</h3>
            <div class="h-60"><canvas id="habitat-chart-${h.replace(/[^a-zA-Z]/g, '')}"></canvas></div>
        </div>
    `).join('');


    dashboardContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="text-sm font-medium text-gray-500">Total Applications</h3>
                <p class="text-3xl font-bold text-gray-800 mt-2">1,072</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="text-sm font-medium text-gray-500">Eligible Applicants</h3>
                <p class="text-3xl font-bold text-gray-800 mt-2">1,041</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="text-sm font-medium text-gray-500">Total Actions Applied For</h3>
                <p class="text-3xl font-bold text-gray-800 mt-2">3,068</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="text-lg font-semibold mb-4">Applications by County</h3>
                <div class="h-80"><canvas id="applications-chart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="text-lg font-semibold mb-4">Total Actions Applied For</h3>
                <div class="h-80 flex justify-center"><canvas id="actions-chart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border lg:col-span-2">
                <h3 class="text-lg font-semibold mb-4">Measured Impacts</h3>
                <div class="h-80 flex justify-center"><canvas id="demographics-chart"></canvas></div>
            </div>
        </div>
        
        <div class="mt-8">
             <h2 class="text-2xl font-bold text-gray-800 mb-6">Habitat Score Trends (Platform-Wide)</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${habitatChartsHTML}
             </div>
        </div>
    `;

    // Create charts
    createApplicationsChart();
    createActionsChart();
    createDemographicsChart();
    
    // Create new habitat charts
    allHabitats.forEach(h => {
        createHabitatTrendChart(
            `habitat-chart-${h.replace(/[^a-zA-Z]/g, '')}`,
            habitatChartData[h].labels,
            habitatChartData[h].data
        );
    });
}

/**
 * Creates the Applications by County bar chart
 */
function createApplicationsChart() {
    const ctx = document.getElementById('applications-chart')?.getContext('2d');
    if (!ctx) return;
    const data = {
        labels: ['Kerry', 'Cork', 'Mayo', 'Limerick', 'Donegal', 'Roscommon', 'Sligo'],
        datasets: [
            {
                label: 'Applications',
                data: [153, 51, 303, 121, 199, 86, 159],
                backgroundColor: 'rgba(16, 163, 74, 0.6)', // green-600
                borderColor: 'rgba(16, 163, 74, 1)',
                borderWidth: 1
            },
            {
                label: 'Eligible',
                data: [150, 50, 295, 113, 198, 81, 154],
                backgroundColor: 'rgba(147, 197, 253, 0.6)', // blue-300
                borderColor: 'rgba(147, 197, 253, 1)',
                borderWidth: 1
            }
        ]
    };
    chartInstances.applications = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });
}

/**
 * Creates the Total Actions Applied For donut chart
 */
function createActionsChart() {
    const ctx = document.getElementById('actions-chart')?.getContext('2d');
    if (!ctx) return;
    const data = {
        labels: ['Fencing', 'Blocking Drains', 'Woodland', 'Sphagnum Moss', 'Hedgerow'],
        datasets: [{
            label: 'Total Actions',
            data: [727, 416, 536, 735, 654], // Sums to 3068
            backgroundColor: [
                'rgba(52, 211, 153, 0.7)', // emerald-400
                'rgba(59, 130, 246, 0.7)', // blue-500
                'rgba(16, 163, 74, 0.7)', // green-600
                'rgba(168, 85, 247, 0.7)', // purple-500
                'rgba(239, 68, 68, 0.7)' // red-500
            ],
            hoverOffset: 4
        }]
    };
    chartInstances.actions = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', } } }
    });
}

/**
 * Creates the Applicant Demographics pie chart
 */
function createDemographicsChart() {
    const ctx = document.getElementById('demographics-chart')?.getContext('2d');
    if (!ctx) return;
    const data = {
        labels: ['Climate', 'People', 'Nature'],
        datasets: [{
            label: 'Applicant Demographics',
            data: [738, 86, 216], // From 'Applicant demographics.csv' - 'All' column
            backgroundColor: [
                'rgba(251, 146, 60, 0.7)', // orange-400
                'rgba(132, 204, 22, 0.7)', // lime-500
                'rgba(34, 197, 94, 0.7)' // green-500
            ],
            hoverOffset: 4
        }]
    };
    chartInstances.demographics = new Chart(ctx, {
        type: 'pie',
        data: data,
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', } } }
    });
}

/**
 * Creates a generic habitat trend line chart
 */
function createHabitatTrendChart(canvasId, labels, data) {
    const ctx = document.getElementById(canvasId)?.getContext('2d');
    if (!ctx) return;
    const chartData = {
        labels: labels,
        datasets: [{
            label: 'Avg. Score',
            data: data,
            fill: false,
            borderColor: 'rgba(16, 163, 74, 1)',
            backgroundColor: 'rgba(16, 163, 74, 0.6)',
            tension: 0.1,
            pointRadius: 4,
            pointBackgroundColor: 'rgba(16, 163, 74, 1)'
        }]
    };
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, max: 10 } },
            plugins: { legend: { display: false } }
        }
    });
}

/**
 * Renders the detailed view for a single project with tabs.
 */
function renderProjectDetail(projectId, defaultTab = 'detail') {
    state.currentView = 'projectDetail';
    state.currentProjectId = projectId;
    state.currentProjectDetailTab = defaultTab;
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.remove('hidden'); // Show create task button
    searchInput.classList.add('hidden');
    setActiveLink(null); // No main link active

    const project = projects.find(p => p.id === projectId);
    if (!project) {
        renderDashboard(); // Fallback
        return;
    }

    pageTitle.textContent = `Project: ${project.landowner}`;

    // Tab structure
    contentArea.innerHTML = `
        <div class="mb-4 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="project-detail-tabs">
                <li class="mr-2">
                    <button class="project-detail-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="detail">
                        <i class="fas fa-user mr-2"></i>Landowner detail
                    </button>
                </li>
                <li class="mr-2">
                    <button class="project-detail-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="habitats">
                        <i class="fas fa-seedling mr-2"></i>Habitats
                    </button>
                </li>
                <li class="mr-2">
                    <button class="project-detail-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="actions">
                        <i class="fas fa-hammer mr-2"></i>Actions
                    </button>
                </li>
                <li class="mr-2">
                    <button class="project-detail-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="payments">
                        <i class="fas fa-euro-sign mr-2"></i>Payments
                    </button>
                </li>
                <li class="mr-2">
                    <button class="project-detail-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="plan">
                        <i class="fas fa-map-marked-alt mr-2"></i>Plan
                    </button>
                </li>
            </ul>
        </div>
        <div id="project-detail-content">
            </div>
    `;

    // Set active tab and render content
    updateProjectDetailView(state.currentProjectDetailTab);
}

/**
 * Updates the project detail view to show the selected tab's content
 */
function updateProjectDetailView(view) {
    state.currentProjectDetailTab = view;
    const content = document.getElementById('project-detail-content');
    if (!content) return;
    
    // Destroy old charts if they exist
    Object.values(chartInstances).forEach(chart => chart.destroy());
    chartInstances = {};

    // Update tab styles
    document.querySelectorAll('.project-detail-tab').forEach(tab => {
        if (tab.dataset.view === view) {
            tab.classList.add('border-green-600', 'text-green-600');
            tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        } else {
            tab.classList.remove('border-green-600', 'text-green-600');
            tab.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        }
    });

    // Render content based on view
    switch (view) {
        case 'detail':
            content.innerHTML = renderProjectDetail_Detail();
            break;
        case 'habitats':
            content.innerHTML = renderProjectDetail_Habitats();
            // Need to create charts *after* innerHTML is set
            const project = projects.find(p => p.id === state.currentProjectId);
            project.habitats.forEach(h => {
                createHabitatTrendChart(
                    `habitat-chart-${h.name.replace(/[^a-zA-Z]/g, '')}`,
                    h.scores.map(s => s.year),
                    h.scores.map(s => s.Overall_Score)
                );
            });
            break;
        case 'actions':
            content.innerHTML = renderProjectDetail_Actions();
            break;
        case 'payments':
            content.innerHTML = renderProjectDetail_Payments();
            break;
        case 'plan':
            content.innerHTML = renderProjectDetail_Plan();
            // Create charts for the plan tab too
            const planProject = projects.find(p => p.id === state.currentProjectId);
            planProject.habitats.forEach(h => {
                createHabitatTrendChart(
                    `plan-habitat-chart-${h.name.replace(/[^a-zA-Z]/g, '')}`,
                    h.scores.map(s => s.year),
                    h.scores.map(s => s.Overall_Score)
                );
            });
            break;
    }
}

// --- Sub-render functions for Project Detail Tabs ---

function renderProjectDetail_Detail() {
    const project = projects.find(p => p.id === state.currentProjectId);
    if (!project) return '';

    const renderOverview = () => `
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <h3 class="font-bold text-lg mb-4">Project Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div><strong class="text-gray-500 block">Landowner:</strong> ${project.landowner}</div>
                <div><strong class="text-gray-500 block">County:</strong> ${project.county}</div>
                <div><strong class="text-gray-500 block">Eircode:</strong> ${project.eircode}</div>
                
                <div><strong class="text-gray-500 block">Herd Number:</strong> ${project.herdNumber}</div>
                <div><strong class="text-gray-500 block">Parcel Label:</strong> ${project.parcelLabel}</div>
                <div><strong class="text-gray-500 block">Digitised Area (Ha):</strong> ${project.digitisedArea}</div>
                <div><strong class="text-gray-500 block">Max Eligible Area (Ha):</strong> ${project.maxEligibleArea}</div>
                <div><strong class="text-gray-500 block">Action Type:</strong> ${project.actionType}</div>
                <div><strong class="text-gray-500 block">Start Date:</strong> ${project.startDate}</div>
                <div class="lg:col-span-2"><strong class="text-gray-500 block">Assigned Farm Advisor:</strong> ${project.specialist}</div>
                <div class="lg:col-span-3"><strong class="text-gray-500 block">Details:</strong> ${project.details}</div>
            </div>
        </div>
    `;
    
    const renderSurvey = () => {
        let surveyContent = '';
        if (project.survey.status === 'Complete') {
            surveyContent = `<div class="bg-green-50 p-4 rounded-md">
                <p class="font-semibold text-green-800">Survey Completed</p>
                <p class="text-sm mt-1"><strong>Satisfaction:</strong> ${'⭐'.repeat(project.survey.data.satisfaction)}</p>
                <p class="text-sm mt-1"><strong>Feedback:</strong> "${project.survey.data.feedback}"</p>
            </div>`;
        } else if (project.survey.status === 'Pending') {
            surveyContent = `<div class="flex items-center justify-between">
                <p class="text-sm text-yellow-700">Survey sent to landowner. Awaiting response.</p>
                <button class="text-sm text-blue-600 hover:underline" onclick="openSurveyModal(true)">Simulate Completion</button>
            </div>`;
        } else {
            surveyContent = `<div class="flex items-center justify-between">
                <p class="text-sm text-gray-600">Participant survey has not been sent yet.</p>
                <button class="bg-gray-200 text-gray-800 px-3 py-1 text-sm rounded-md font-semibold hover:bg-gray-300" onclick="sendSurvey(${project.id})">
                    <i class="fas fa-paper-plane mr-2"></i>Send Survey
                </button>
            </div>`;
        }
        return `<div class="bg-white p-6 rounded-lg shadow-sm border">
            <h3 class="font-bold text-lg mb-4">Participant Survey</h3>
            ${surveyContent}
        </div>`;
    };

    const renderActivityLog = () => {
        const logItems = project.activityLog.map(log => `
            <div class="flex items-start py-2">
                <div class="w-2 h-2 bg-gray-300 rounded-full mt-1.5 mr-3"></div>
                <div>
                    <p class="text-sm">${log.activity}</p>
                    <p class="text-xs text-gray-400">${log.date}</p>
                </div>
            </div>`).join('');
        return `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="font-bold text-lg mb-2">Activity Log</h3>
                <div class="max-h-96 overflow-y-auto pr-2">${logItems}</div>
            </div>`;
    };

    return `
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="xl:col-span-2 space-y-6">
                ${renderOverview()}
                ${renderSurvey()}
            </div>
            <div class="space-y-6">
                ${renderActivityLog()}
            </div>
        </div>
    `;
}

function renderProjectDetail_Habitats() {
    const project = projects.find(p => p.id === state.currentProjectId);
    if (!project) return '';

    const habitatCards = project.habitats.map(h => {
        const scoreRows = h.scores.map(s => `
            <tr class="border-b">
                <td class="px-4 py-2 text-sm">${s.year}</td>
                <td class="px-4 py-2 text-sm">${s.A_Integrity}</td>
                <td class="px-4 py-2 text-sm">${s.B_Structure}</td>
                <td class="px-4 py-2 text-sm">${s.C_Management}</td>
                <td class="px-4 py-2 font-bold text-gray-800">${s.Overall_Score}</td>
            </tr>
        `).join('');

        return `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="font-bold text-lg mb-4">${h.name}</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Scorecard Data</h4>
                        <div class="overflow-x-auto rounded-md border">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Year</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">A</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">B</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">C</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Overall</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${scoreRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">3-Year Trend (Overall Score)</h4>
                        <div class="h-60 w-full"><canvas id="habitat-chart-${h.name.replace(/[^a-zA-Z]/g, '')}"></canvas></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                 <h2 class="text-xl font-bold text-gray-800 mb-4">Habitats & Scores</h2>
                 <p class="text-gray-600 mb-6">Showing scorecard results and trends for the landowner's ${project.habitats.length} primary habitats.</p>
            </div>
            ${habitatCards}
        </div>
    `;
}

function renderProjectDetail_Actions() {
    const project = projects.find(p => p.id === state.currentProjectId);
    if (!project) return '';

    // AECM Actions Card
    const renderAECMActions = () => {
        const actionRows = project.actions.map(a => `
            <tr class="border-b">
                <td class="px-4 py-3 text-sm font-semibold text-gray-800">${a.name}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${a.quantity}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${a.rate}</td>
                <td class="px-4 py-3 text-sm">
                    <span class="text-xs font-semibold px-3 py-1 rounded-full ${actionStatusStyles[a.status] || 'bg-gray-100 text-gray-800'}">${a.status}</span>
                </td>
                <td class="px-4 py-3 text-sm text-right">
                    <button class="text-green-600 hover:text-green-800 font-medium" onclick="logGenericAction('${a.name}', 'Completed')">Complete</button>
                    <button class="text-blue-600 hover:text-blue-800 font-medium ml-3" onclick="logGenericAction('${a.name}', 'Authorised')">Authorise</button>
                </td>
            </tr>
        `).join('');

        return `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="font-bold text-lg mb-4">AECM Actions</h3>
                <div class="overflow-x-auto rounded-md border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Action</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Quantity</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Rate</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${actionRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    };

    // On-site Assessments Card
    const renderAssessments = () => {
        const assessmentItems = project.assessments.length > 0 ?
            project.assessments.map(a => `
                <div class="border-b last:border-b-0 py-3">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold">${a.assessor}</p>
                        <p class="text-sm text-gray-500">${a.date}</p>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">${a.notes}</p>
                    <div class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-camera mr-1"></i> ${a.photos} photos | <i class="fas fa-map-marker-alt ml-3 mr-1"></i> ${a.location}
                    </div>
                </div>`).join('') :
            '<p class="text-sm text-gray-500 py-4 text-center">No assessments recorded yet.</p>';

        return `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">On-Site Assessments</h3>
                    <button class="bg-blue-500 text-white px-3 py-1 text-sm rounded-md font-semibold hover:bg-blue-600" onclick="openAssessmentModal()">
                        <i class="fas fa-plus mr-1"></i> Add Assessment
                    </button>
                </div>
                <div class="max-h-60 overflow-y-auto pr-2">${assessmentItems}</div>
            </div>`;
    };

    // Communication / Documents Card
    const renderCommActions = () => {
        const reportAttachment = project.actionType === 'Blocking Drains' ?
            `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="font-bold text-lg mb-4">Attached Documents</h3>
                <a href="#" class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100">
                    <i class="fas fa-file-pdf text-red-500 text-xl mr-3"></i>
                    <div>
                        <p class="font-semibold">Hydrologist_Report.pdf</p>
                        <p class="text-xs text-gray-500">1.2 MB - Uploaded 2025-08-20</p>
                    </div>
                </a>
            </div>
            ` : '';

        return `
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <h3 class="font-bold text-lg mb-4">Communication</h3>
                    <button onclick="window.open('https://wa.me/${project.phone}', '_blank')" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-all flex items-center justify-center">
                        <i class="fab fa-whatsapp text-xl mr-3"></i> Message Landowner via WhatsApp
                    </button>
                </div>
                ${reportAttachment}
            </div>
        `;
    };

    return `
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="xl:col-span-2 space-y-6">
                ${renderAECMActions()}
                ${renderAssessments()}
            </div>
            <div class="space-y-6">
                ${renderCommActions()}
            </div>
        </div>
    `;
}

function renderProjectDetail_Payments() {
    const project = projects.find(p => p.id === state.currentProjectId);
    if (!project) return '';

    const paymentScaleText = project.isOFS3 ? 
        '<span class="font-bold text-yellow-700">Reduced (OFS3)</span>' : 
        '<span class="font-bold text-green-700">Full</span>';

    const habitatPaymentTables = project.habitats.map(h => {
        const paymentRows = h.scores.map(s => `
            <tr class="border-b">
                <td class="px-4 py-3 text-sm font-semibold">${s.year}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${s.Overall_Score}</td>
                <td class="px-4 py-3 text-sm font-semibold text-gray-800">€${s.paymentAmount}</td>
                <td class="px-4 py-3 text-sm">
                    <span class="text-xs font-semibold px-3 py-1 rounded-full ${paymentStatusStyles[s.paymentStatus] || 'bg-gray-100 text-gray-800'}">${s.paymentStatus}</span>
                </td>
            </tr>
        `).join('');

        return `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="font-bold text-lg mb-4">Payment Trail: ${h.name}</h3>
                <div class="overflow-x-auto rounded-md border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Year</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Score</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Amount</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${paymentRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Payment Details</h2>
                <p class="text-gray-600">Landowner is on the ${paymentScaleText} payment scale.</p>
            </div>
            ${habitatPaymentTables}
        </div>
    `;
}

function renderProjectDetail_Plan() {
    const project = projects.find(p => p.id === state.currentProjectId);
    if (!project) return '';

    const renderMap = () => `
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <h3 class="font-bold text-lg mb-4">GIS Farm Plan</h3>
            <div class="bg-gray-200 h-96 rounded-md flex items-center justify-center text-gray-500">
                <div class="text-center">
                    <i class="fas fa-map-marked-alt fa-4x mb-4"></i>
                    <h4 class="text-xl font-semibold">GIS Map Placeholder</h4>
                    <p class="mt-2">Farm Area: 34.5 Ha</p>
                    <p>Field Boundaries: 1, 2, 3, 4, 5</p>
                </div>
            </div>
        </div>
    `;

    const renderRecommendedActions = () => {
        const actionItems = project.recommendedActions.map(a => `
            <li class="flex justify-between items-center py-3 border-b last:border-b-0">
                <span class="text-sm text-gray-700">${a.name}</span>
                <span class="text-xs font-semibold px-3 py-1 rounded-full ${planActionStatusStyles[a.status] || 'bg-gray-100 text-gray-800'}">${a.status}</span>
            </li>
        `).join('');
        
        return `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Recommended Actions</h3>
                    <div>
                        <button class="text-sm bg-blue-500 text-white px-3 py-1 rounded-md font-semibold hover:bg-blue-600">Add</button>
                        <button class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md font-semibold hover:bg-gray-300 ml-2">Edit</button>
                    </div>
                </div>
                <ul class="max-h-60 overflow-y-auto pr-2">
                    ${actionItems}
                </ul>
            </div>
        `;
    };

    const renderNotes = () => `
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <h3 class="font-bold text-lg mb-4">Notes</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Team Notes</label>
                <textarea class="w-full p-2 border border-gray-300 rounded-md bg-gray-50" rows="4" readonly>${project.planNotes}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Farmer Comments</label>
                <textarea class="w-full p-2 border border-gray-300 rounded-md bg-gray-50" rows="3" readonly>${project.farmerComments}</textarea>
            </div>
        </div>
    `;
    
    const renderHabitatTrends = () => {
        const habitatCharts = project.habitats.map(h => `
            <div class="border-b last:border-b-0 py-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">${h.name} Score Trend</h4>
                <div class="h-40 w-full"><canvas id="plan-habitat-chart-${h.name.replace(/[^a-zA-Z]/g, '')}"></canvas></div>
            </div>
        `).join('');

        return `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="font-bold text-lg mb-2">Habitat Score Trends</h3>
                <div class="max-h-96 overflow-y-auto pr-2">
                    ${habitatCharts}
                </div>
            </div>
        `;
    };

    return `
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="xl:col-span-2 space-y-6">
                ${renderMap()}
                ${renderRecommendedActions()}
            </div>
            <div class="space-y-6">
                ${renderHabitatTrends()}
                ${renderNotes()}
            </div>
        </div>
    `;
}

/**
 * Renders the survey templates management page.
 */
function renderSurveysPage() {
    state.currentView = 'surveys';
    state.currentProjectId = null;
    state.currentSurveyTemplateId = null;
    pageTitle.textContent = 'Survey Templates';
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    searchInput.classList.add('hidden');
    setActiveLink(surveysLink);

    const surveyCards = surveyTemplates.map(template => `
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col hover:shadow-lg transition-shadow">
            <div class="flex-grow">
                <div class="flex items-center text-green-600 mb-3">
                    <i class="fas ${template.icon || 'fa-poll'} fa-lg mr-3"></i>
                    <h3 class="font-bold text-lg text-gray-800">${template.name}</h3>
                </div>
                <p class="text-sm text-gray-600 mb-4">${template.description}</p>
            </div>
            <div class="flex justify-between items-center text-xs text-gray-500 pt-4 border-t">
                <span>${template.questionCount} Questions</span>
                <div>
                    <button class="hover:text-green-600 mr-3" onclick="navigateToSurveyEditor(${template.id})"><i class="fas fa-edit mr-1"></i> Edit</button>
                    <a href="#" class="hover:text-green-600"><i class="fas fa-copy mr-1"></i> Duplicate</a>
                </div>
            </div>
        </div>
    `).join('');

    contentArea.innerHTML = `
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-semibold">Manage Surveys</h2>
                <p class="text-gray-500">Create, edit, and manage all survey and assessment templates.</p>
            </div>
            <div>
                <button class="bg-blue-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-700 transition-all shadow-md mr-2" onclick="openNewTaskModal('Survey')">
                    <i class="fas fa-plus mr-2"></i>Create Survey Task
                </button>
                <button class="bg-green-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-700 transition-all shadow-md">
                    <i class="fas fa-plus mr-2"></i>Create Survey
                </button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            ${surveyCards}
        </div>
    `;
}

/**
 * Renders the new Survey Editor page
 */
function navigateToSurveyEditor(templateId) {
    state.currentView = 'surveyEditor';
    state.currentSurveyTemplateId = templateId;
    renderSurveyEditor();
}

function renderSurveyEditor() {
    const template = surveyTemplates.find(t => t.id === state.currentSurveyTemplateId);
    if (!template) {
        renderSurveysPage();
        return;
    }
    
    pageTitle.textContent = `Edit: ${template.name}`;
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    searchInput.classList.add('hidden');
    setActiveLink(surveysLink); // Keep surveys link active

    const questionFields = template.questions.map((q, index) => `
        <div class="p-4 border border-gray-200 rounded-md bg-white">
            <div class="flex justify-between items-center mb-2">
                <p class="text-xs font-semibold text-gray-500">Question ${index + 1}</p>
                <button class="text-xs text-red-500 hover:text-red-700">Remove</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Label (Question Text)</label>
                    <input type="text" value="${q.label}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Type</label>
                    <select class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm bg-white">
                        <option ${q.type === 'text' ? 'selected' : ''}>text</option>
                        <option ${q.type === 'number' ? 'selected' : ''}>number</option>
                        <option ${q.type === 'date' ? 'selected' : ''}>date</option>
                        <option ${q.type === 'radio' ? 'selected' : ''}>radio</option>
                        <option ${q.type === 'checkbox' ? 'selected' : ''}>checkbox</option>
                        <option ${q.type === 'textarea' ? 'selected' : ''}>textarea</option>
                    </select>
                </div>
            </div>
            ${(q.type === 'radio' || q.type === 'checkbox') ? `
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700">Options (comma-separated)</label>
                    <input type="text" value="${q.options ? q.options.join(', ') : ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                </div>
            ` : ''}
        </div>
    `).join('');

    contentArea.innerHTML = `
        <div class="flex justify-between items-center mb-6">
            <div>
                <button onclick="renderSurveysPage()" class="text-sm text-green-600 hover:text-green-800 font-semibold">
                    <i class="fas fa-arrow-left mr-2"></i>Back to All Surveys
                </button>
                <h2 class="text-xl font-semibold mt-1">Editing: ${template.name}</h2>
                <p class="text-gray-500">${template.description}</p>
            </div>
            <button class="bg-blue-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-700 transition-all shadow-md" onclick="approveScorecard(${template.id}, '${template.name}')">
                <i class="fas fa-check mr-2"></i>Approve Structure
            </button>
        </div>
        
        <div class="space-y-4 mb-6">
            ${questionFields}
        </div>
        
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
             <h3 class="font-bold text-lg mb-4">Add New Question</h3>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                 <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Label (Question Text)</label>
                    <input type="text" placeholder="e.g., What is the soil condition?" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Type</label>
                    <select class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm bg-white">
                        <option>text</option>
                        <option>number</option>
                        <option>date</option>
                        <option>radio</option>
                        <option>checkbox</option>
                        <option>textarea</option>
                    </select>
                </div>
             </div>
             <div class="text-right mt-4">
                 <button class="bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700">
                    <i class="fas fa-plus mr-2"></i>Add Question
                 </button>
             </div>
        </div>
    `;
}

/**
 * Renders the team members list view.
 */
function renderTeamMembers() {
    state.currentView = 'team';
    state.currentProjectId = null;
    pageTitle.textContent = 'Team Dashboard';
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    searchInput.classList.add('hidden');
    setActiveLink(teamLink);

    const teamCards = teamMembers.map(member => {
        const assignmentItems = member.assignments.map(assign => {
            const project = projects.find(p => p.id === assign.projectId);
            if (!project) return ''; // Skip if project not found (data integrity)
            return `
                <div class_id="team-assignment-item" class="list-item-card grid grid-cols-10 gap-4 items-center px-4 py-3 border-b cursor-pointer" onclick="navigateToProject(${project.id})">
                    <div class="col-span-3 font-semibold text-gray-800">${project.landowner}</div>
                    <div class="col-span-2 text-sm text-gray-600">${project.county}</div>
                    <div class="col-span-3 text-sm text-gray-600">${project.actionType}</div>
                    <div class="col-span-2">
                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${assignmentStatusStyles[assign.status] || 'bg-gray-100 text-gray-800'}">${assign.status}</span>
                    </div>
                </div>
            `;
        }).join('');

        const assignmentHeader = `
            <div class="px-4 py-2 bg-gray-50 grid grid-cols-10 gap-4 text-xs font-bold text-gray-500 uppercase rounded-t-lg mt-4">
                <div class="col-span-3">Assigned Landowner</div>
                <div class="col-span-2">County</div>
                <div class="col-span-3">Action Type</div>
                <div class="col-span-2">Assignment Status</div>
            </div>
        `;

        return `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-4 border-b">
                    <h3 class="text-xl font-semibold">${member.name}</h3>
                    <div class="flex items-center text-sm text-gray-500 space-x-6 mt-1">
                        <span><i class="fas fa-user-tie w-4 mr-2 text-gray-400"></i>${member.role}</span>
                        <span><i class="fas fa-envelope w-4 mr-2 text-gray-400"></i>${member.email}</span>
                        <span><i class="fas fa-phone w-4 mr-2 text-gray-400"></i>${member.phone}</span>
                    </div>
                </div>
                <div class="assignments-list">
                    ${member.assignments.length > 0 ? assignmentHeader : ''}
                    <div class="max-h-60 overflow-y-auto">
                        ${member.assignments.length > 0 ? assignmentItems : '<p class="text-sm text-gray-500 p-4 text-center">No projects currently assigned.</p>'}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    contentArea.innerHTML = `
        <div class="max-w-6xl mx-auto">
            ${teamCards}
        </div>
    `;
}

/**
 * Renders the new Task Management page
 */
function renderTasksPage() {
    state.currentView = 'tasks';
    state.currentProjectId = null;
    pageTitle.textContent = 'Task Management';
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    searchInput.classList.add('hidden');
    setActiveLink(tasksLink);

    const teamCards = teamMembers.map(member => {
        const tasksForMember = globalTaskList.filter(t => t.teamMember === member.name);
        
        const taskItems = tasksForMember.map(task => {
            const project = projects.find(p => p.landowner === task.landowner);
            return `
                <div class_id="team-task-item" class="list-item-card grid grid-cols-10 gap-4 items-center px-4 py-3 border-b ${project ? 'cursor-pointer' : ''}" ${project ? `onclick="navigateToProject(${project.id})"` : ''}>
                    <div class="col-span-3 font-semibold text-gray-800">${task.name} ${task.landowner}</div>
                    <div class="col-span-3 text-sm text-gray-600">${task.landowner}</div>
                    <div class="col-span-2 text-sm text-gray-600">${task.due}</div>
                    <div class="col-span-2">
                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${assignmentStatusStyles[task.status] || 'bg-gray-100 text-gray-800'}">${task.status}</span>
                    </div>
                </div>
            `;
        }).join('');

        const taskHeader = `
            <div class="px-4 py-2 bg-gray-50 grid grid-cols-10 gap-4 text-xs font-bold text-gray-500 uppercase rounded-t-lg mt-4">
                <div class="col-span-3">Task</div>
                <div class="col-span-3">Related Landowner</div>
                <div class="col-span-2">Due Date</div>
                <div class="col-span-2">Status</div>
            </div>
        `;

        return `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-4 border-b">
                    <h3 class="text-xl font-semibold">${member.name}</h3>
                    <div class="flex items-center text-sm text-gray-500 space-x-6 mt-1">
                        <span><i class="fas fa-user-tie w-4 mr-2 text-gray-400"></i>${member.role}</span>
                        <span><i class="fas fa-tasks w-4 mr-2 text-gray-400"></i>${tasksForMember.length} tasks</span>
                    </div>
                </div>
                <div class="tasks-list">
                    ${tasksForMember.length > 0 ? taskHeader : ''}
                    <div class="max-h-60 overflow-y-auto">
                        ${tasksForMember.length > 0 ? taskItems : '<p class="text-sm text-gray-500 p-4 text-center">No tasks currently assigned.</p>'}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    contentArea.innerHTML = `
        <div class="max-w-6xl mx-auto">
            ${teamCards}
        </div>
    `;
}

/**
 * Renders the new Plans List page
 */
function renderPlansListPage() {
    state.currentView = 'plansList';
    state.currentProjectId = null;
    pageTitle.textContent = 'Farm Plans';
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    searchInput.classList.remove('hidden'); // Show search for this page
    setActiveLink(plansLink);

    const filteredProjects = projects.filter(p => 
        p.landowner.toLowerCase().includes(state.filterText.toLowerCase()) ||
        p.eircode.toLowerCase().includes(state.filterText.toLowerCase()) ||
        p.herdNumber.includes(state.filterText)
    );
    
    const planRows = filteredProjects.map(p => `
        <tr class="list-item-card border-b border-l-4 border-transparent hover:bg-gray-50 cursor-pointer" onclick="navigateToProject(${p.id}, 'plan')">
            <td class="px-4 py-3 font-semibold text-gray-800">${p.landowner}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${p.eircode}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${p.herdNumber}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${p.partnershipNumber}</td>
            <td class="px-4 py-3 text-sm">
                <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusStyles[p.status] || 'bg-gray-100 text-gray-800'}">${p.status}</span>
            </td>
        </tr>
    `).join('');

    const planHeader = `
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Landowner</th>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Eircode</th>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Herd Number</th>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Partnership No.</th>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
            </tr>
        </thead>
    `;

    contentArea.innerHTML = `
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-4 border-b">
                <h2 class="text-xl font-semibold">All Farm Plans</h2>
                <p class="text-sm text-gray-500">Select a landowner to view or edit their farm plan.</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    ${planHeader}
                    <tbody class="divide-y divide-gray-200">
                        ${planRows}
                    </tbody>
                </table>
            </div>
             ${filteredProjects.length === 0 ? '<p class="text-sm text-gray-500 p-8 text-center">No landowners found matching your search.</p>' : ''}
        </div>
    `;
}

/**
 * Renders the new Audit Trail page
 */
function renderAuditTrailPage() {
    state.currentView = 'auditTrail';
    state.currentProjectId = null;
    pageTitle.textContent = 'Global Audit Trail';
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    searchInput.classList.add('hidden');
    setActiveLink(auditTrailLink);

    const logRows = globalAuditLog.map(log => `
        <tr class="border-b">
            <td class="px-4 py-3 text-sm font-semibold text-gray-800">${log.landowner}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${log.change}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${log.date}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${log.time}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${log.teamMember}</td>
        </tr>
    `).join('');

    const logHeader = `
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Entity/Landowner</th>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Change Made</th>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Date</th>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Time</th>
                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Team Member</th>
            </tr>
        </thead>
    `;
    
    contentArea.innerHTML = `
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-4 border-b">
                <h2 class="text-xl font-semibold">Audit Trail</h2>
                <p class="text-sm text-gray-500">A log of all major changes made across the platform.</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    ${logHeader}
                    <tbody class="divide-y divide-gray-200">
                        ${logRows}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

/**
 * Renders the new Settings page
 */
function renderSettingsPage() {
    state.currentView = 'settings';
    state.currentProjectId = null;
    pageTitle.textContent = 'Settings';
    addProjectBtn.classList.add('hidden');
    addTaskBtn.classList.add('hidden');
    searchInput.classList.add('hidden');
    setActiveLink(settingsLink);

    // Tab structure
    contentArea.innerHTML = `
        <div class="mb-4 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="settings-tabs">
                <li class="mr-2">
                    <button class="settings-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="general">
                        <i class="fas fa-sliders-h mr-2"></i>General
                    </button>
                </li>
                <li class="mr-2">
                    <button class="settings-tab inline-block p-4 border-b-2 rounded-t-lg" data-view="users">
                        <i class="fas fa-users mr-2"></i>User Management
                    </button>
                </li>
            </ul>
        </div>
        <div id="settings-content" class="max-w-4xl mx-auto">
            </div>
    `;

    // Set active tab and render content
    updateSettingsView(state.currentSettingsTab);
}

/**
 * Updates the settings page to show the selected tab's content
 */
function updateSettingsView(view) {
    state.currentSettingsTab = view;
    const content = document.getElementById('settings-content');
    if (!content) return;

    // Update tab styles
    document.querySelectorAll('.settings-tab').forEach(tab => {
        if (tab.dataset.view === view) {
            tab.classList.add('border-green-600', 'text-green-600');
            tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        } else {
            tab.classList.remove('border-green-600', 'text-green-600');
            tab.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        }
    });

    // Render content based on view
    if (view === 'general') {
        content.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h3 class="font-bold text-lg mb-4">Platform Filters</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Project Year</label>
                        <select class="mt-1 block w-full md:w-1/2 px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm">
                            <option>2026</option>
                            <option>2025</option>
                            <option>2024</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Applications</label>
                        <select class="mt-1 block w-full md:w-1/2 px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm">
                            <option>By County</option>
                            <option>By Action</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    } else {
        // User Management Tab
        const userRows = teamMembers.map(user => `
            <tr class="border-b">
                <td class="px-4 py-3 font-semibold text-gray-800">${user.name}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${user.role}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${user.email}</td>
                <td class="px-4 py-3 text-sm text-right">
                    <button class="text-green-600 hover:text-green-800 font-medium">Edit</button>
                </td>
            </tr>
        `).join('');

        content.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-4 border-b flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg">User Management</h3>
                        <p class="text-sm text-gray-500">Manage team member accounts and permissions.</p>
                    </div>
                    <button class="bg-green-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>Add User
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Name</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Role</th>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Email</th>
                                <th class="px-4 py-2"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${userRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
}


// --- MODAL FUNCTIONS ---
function openCommunicationModal(filterType) {
    const modal = document.getElementById('communication-modal');
    let options = [];
    let filterLabel = '';
    
    // Logic to dynamically set filter options
    switch (filterType) {
        case 'county':
            filterLabel = 'County';
            const counties = [...new Set(projects.map(p => p.county))];
            options = counties.map(c => `<option value="${c}">${c}</option>`);
            break;
        case 'actionType':
            filterLabel = 'Action Type';
            const actionTypes = [...new Set(projects.map(p => p.actionType))];
            options = actionTypes.map(a => `<option value="${a}">${a}</option>`);
            break;
        case 'advisor':
            filterLabel = 'Farm Advisor';
            options = teamMembers.map(t => `<option value="${t.name}">${t.name}</option>`);
            break;
        case 'habitat':
            filterLabel = 'Habitat Type';
            const habitats = [...new Set(projects.flatMap(p => p.habitats.map(h => h.name)))];
            options = habitats.map(h => `<option value="${h}">${h}</option>`);
            break;
        case 'payment':
            filterLabel = 'Payment Status';
            options = ['Paid', 'Authorisation', 'Pending'].map(s => `<option value="${s}">${s}</option>`);
            break;
        case 'actionStatus':
            filterLabel = 'Action Status';
            options = ['Authorised', 'Completed', 'Paid'].map(s => `<option value="${s}">${s}</option>`);
            break;
        default:
            filterLabel = 'County';
            const allCounties = [...new Set(projects.map(p => p.county))];
            options = allCounties.map(c => `<option value="${c}">${c}</option>`);
    }

    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-8 m-4">
            <h2 class="text-2xl font-bold mb-6">Bulk Communication</h2>
            <form id="communication-form">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Channel</label>
                        <div class="flex rounded-md shadow-sm">
                            <button type="button" id="comm-channel-email" class="channel-btn relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 bg-green-100 border-green-500 text-green-700">
                                <i class="fas fa-envelope mr-2"></i> Email
                            </button>
                            <button type="button" id="comm-channel-whatsapp" class="channel-btn -ml-px relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">
                                <i class="fab fa-whatsapp mr-2"></i> WhatsApp
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="comm-filter" class="block text-sm font-medium text-gray-700">Target Landowners By ${filterLabel}</label>
                        <select id="comm-filter" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            <option value="all">All ${filterLabel}s</option>
                            ${options.join('')}
                        </select>
                    </div>
                </div>
                <div class="mt-6">
                    <label for="comm-message" class="block text-sm font-medium text-gray-700">Message</label>
                    <textarea id="comm-message" rows="6" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Dear Landowner..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('communication-modal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold">Send Message</button>
                </div>
            </form>
        </div>
    `;
    modal.classList.add('flex');
    modal.classList.remove('hidden');
    // Add event listeners for the channel switcher
    const emailBtn = modal.querySelector('#comm-channel-email');
    const whatsappBtn = modal.querySelector('#comm-channel-whatsapp');
    emailBtn.addEventListener('click', () => {
        emailBtn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
        whatsappBtn.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
    });
    whatsappBtn.addEventListener('click', () => {
        whatsappBtn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
        emailBtn.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
    });
    document.getElementById('communication-form').onsubmit = handleSendMessage;
}

function openNewProjectModal() {
    const modal = document.getElementById('new-project-modal');
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 m-4">
            <h2 class="text-2xl font-bold mb-6">Create New Participant</h2>
            <form id="new-project-form">
                <div class="mb-4">
                    <label for="landowner" class="block text-sm font-medium text-gray-700">Landowner Name</label>
                    <input type="text" id="landowner" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="county" class="block text-sm font-medium text-gray-700">County</label>
                        <input type="text" id="county" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div class="mb-4">
                        <label for="eircode" class="block text-sm font-medium text-gray-700">Eircode</label>
                        <input type="text" id="eircode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="A12 B3C4">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="actionType" class="block text-sm font-medium text-gray-700">Action Type</label>
                    <select id="actionType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>Fencing</option>
                        <option>Blocking Drains</option>
                        <option>Woodland</option>
                        <option>Sphagnum Moss</option>
                        <option>Hedgerow</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="details" class="block text-sm font-medium text-gray-700">Project Details</label>
                    <textarea id="details" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('new-project-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Create Project</button>
                </div>
            </form>
        </div>`;
    modal.classList.add('flex');
    modal.classList.remove('hidden');
    document.getElementById('new-project-form').onsubmit = handleAddProject;
}

function openAssessmentModal() {
    const modal = document.getElementById('assessment-modal');
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 m-4">
            <h2 class="text-2xl font-bold mb-6">Add On-Site Assessment</h2>
            <form id="assessment-form">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="assessor" class="block text-sm font-medium text-gray-700">Assessor</label>
                        <input type="text" id="assessor" required value="Maria Garcia" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="assessment-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="assessment-date" required value="${new Date().toISOString().slice(0, 10)}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                    <textarea id="notes" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div class="mb-6 flex items-center justify-between p-3 bg-gray-50 rounded-md">
                    <label for="photos" class="text-sm font-medium text-gray-700">Attach Photos</label>
                    <input type="file" id="photos" multiple class="text-sm text-gray-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('assessment-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Submit Assessment</button>
                </div>
            </form>
        </div>`;
    modal.classList.add('flex');
    modal.classList.remove('hidden');
    document.getElementById('assessment-form').onsubmit = handleAddAssessment;
}

function openSurveyModal(isCompletion = false) {
    const project = projects.find(p => p.id === state.currentProjectId);
    const modal = document.getElementById('survey-modal');
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-xl p-8 m-4">
            <h2 class="text-2xl font-bold mb-2">Participant Survey</h2>
            <p class="text-sm text-gray-500 mb-6">This form simulates the experience for landowner ${project.landowner}.</p>
            <form id="survey-form">
                <div class="mb-4">
                    <p class="block text-sm font-medium text-gray-700 mb-2">Overall, how satisfied are you with the program?</p>
                    <div class="flex space-x-2 text-3xl cursor-pointer" id="satisfaction-rating">
                        <i class="far fa-star text-gray-300" data-value="1"></i>
                        <i class="far fa-star text-gray-300" data-value="2"></i>
                        <i class="far fa-star text-gray-300" data-value="3"></i>
                        <i class="far fa-star text-gray-300" data-value="4"></i>
                        <i class="far fa-star text-gray-300" data-value="5"></i>
                    </div>
                    <input type="hidden" id="satisfaction" required>
                </div>
                <div class="mb-6">
                    <label for="feedback" class="block text-sm font-medium text-gray-700">Do you have any feedback to help us improve?</label>
                    <textarea id="feedback" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('survey-modal')">Close</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Submit Survey</button>
                </div>
            </form>
        </div>`;
    modal.classList.add('flex');
    modal.classList.remove('hidden');
    const stars = modal.querySelectorAll('#satisfaction-rating i');
    stars.forEach(star => {
        star.addEventListener('click', (e) => {
            const rating = e.target.dataset.value;
            document.getElementById('satisfaction').value = rating;
            stars.forEach(s => {
                s.classList.toggle('fas', s.dataset.value <= rating);
                s.classList.toggle('text-yellow-400', s.dataset.value <= rating);
                s.classList.toggle('far', s.dataset.value > rating);
                s.classList.toggle('text-gray-300', s.dataset.value > rating);
            });
        });
    });
    document.getElementById('survey-form').onsubmit = handleAddSurvey;
}

function openNewTaskModal(taskType = 'Site Visit') {
    const modal = document.getElementById('new-task-modal');
    const project = projects.find(p => p.id === state.currentProjectId);
    
    const title = taskType === 'Survey' ? 'Create New Survey Task' : 'Create New Task';
    
    // Default advisor
    let defaultAdvisor = '';
    if (project && project.specialist && project.specialist !== 'N/A') {
        defaultAdvisor = project.specialist;
    }
    
    // Team member options
    const teamOptions = teamMembers.map(t => 
        `<option value="${t.name}" ${t.name === defaultAdvisor ? 'selected' : ''}>${t.name}</option>`
    ).join('');
    
    // Task type options
    const taskTypeOptions = ['Site Visit', 'Survey', 'Data Collection', 'Plan Draft'].map(t =>
        `<option value="${t}" ${t === taskType ? 'selected' : ''}>${t}</option>`
    ).join('');

    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 m-4">
            <h2 class="text-2xl font-bold mb-6">${title}</h2>
            <form id="new-task-form">
                <div class="mb-4">
                    <label for="task-type" class="block text-sm font-medium text-gray-700">Task Type</label>
                    <select id="task-type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" ${taskType === 'Survey' ? 'disabled' : ''}>
                        ${taskTypeOptions}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="task-note" class="block text-sm font-medium text-gray-700">Note</label>
                    <textarea id="task-note" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., Check fencing on north parcel"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="task-date" class="block text-sm font-medium text-gray-700">Completion Date</label>
                        <input type="date" id="task-date" required value="${new Date().toISOString().slice(0, 10)}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="mb-4">
                        <label for="task-assignee" class="block text-sm font-medium text-gray-700">Assign Team Member</label>
                        <select id="task-assignee" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            ${teamOptions}
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="closeModal('new-task-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create Task</button>
                </div>
            </form>
        </div>`;
    modal.classList.add('flex');
    modal.classList.remove('hidden');
    document.getElementById('new-task-form').onsubmit = handleAddTask;
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    document.getElementById(modalId).classList.remove('flex');
}

function showToast(message = 'Message sent successfully!') {
    const toast = document.getElementById('toast-notification');
    toast.querySelector('p').textContent = message;
    toast.classList.remove('opacity-0', '-translate-y-10');
    toast.classList.add('opacity-100', 'translate-y-0');
    setTimeout(() => {
        toast.classList.remove('opacity-100', 'translate-y-0');
        toast.classList.add('opacity-0', '-translate-y-10');
    }, 3000);
}

// --- HANDLER FUNCTIONS ---
function handleSendMessage(e) {
    e.preventDefault();
    // In a real app, this would trigger a backend process
    console.log('Sending message:', {
        filter: document.getElementById('comm-filter').value,
        message: document.getElementById('comm-message').value,
    });
    closeModal('communication-modal');
    showToast();
}

function handleAddProject(e) {
    e.preventDefault();
    const newProject = {
        id: projects.length + 1,
        landowner: document.getElementById('landowner').value,
        county: document.getElementById('county').value,
        eircode: document.getElementById('eircode').value.toUpperCase(),
        phone: `35387${Math.floor(1000000 + Math.random() * 9000000)}`,
        actionType: document.getElementById('actionType').value,
        status: 'Application Review',
        startDate: new Date().toISOString().slice(0, 10),
        specialist: 'N/A',
        details: document.getElementById('details').value,
        assessments: [],
        survey: { status: 'Not Sent', data: null },
        activityLog: [
            { date: new Date().toISOString().slice(0, 10), activity: 'Landowner submitted application.' }
        ]
        // Note: New fields (herdNumber, habitats, etc.) would be added here
        // For simplicity in the prototype, we'll rely on a page refresh or generateProjects
    };
    projects.unshift(newProject);
    closeModal('new-project-modal');
    renderPlansListPage(); // Refresh the plans list
}

function handleAddAssessment(e) {
    e.preventDefault();
    const project = projects.find(p => p.id === state.currentProjectId);
    const newAssessment = {
        assessor: document.getElementById('assessor').value,
        date: document.getElementById('assessment-date').value,
        notes: document.getElementById('notes').value,
        photos: document.getElementById('photos').files.length,
        location: '52.14, -9.52' // Mock location
    };
    project.assessments.unshift(newAssessment);
    logActivity(project.id, `On-site assessment completed by ${newAssessment.assessor}.`);
    closeModal('assessment-modal');
    updateProjectDetailView('actions'); // Refresh the actions tab
}

function handleAddTask(e) {
    e.preventDefault();
    const taskType = document.getElementById('task-type').value;
    const note = document.getElementById('task-note').value;
    const date = document.getElementById('task-date').value;
    const assignee = document.getElementById('task-assignee').value;
    
    let landownerName = 'System'; // Default for system tasks
    const project = projects.find(p => p.id === state.currentProjectId);
    if(project) {
        landownerName = project.landowner;
    }

    const newTask = {
        id: globalTaskList.length + 1,
        name: `${taskType}: ${note}`,
        landowner: landownerName,
        teamMember: assignee,
        due: date,
        status: 'Pending'
    };
    
    globalTaskList.unshift(newTask);
    
    // Log it
    const logMsg = `New task created: '${taskType}' for ${landownerName}, assigned to ${assignee}.`;
    logSystemActivity(logMsg, landownerName);
    
    closeModal('new-task-modal');
    
    // Refresh task page if on it
    if(state.currentView === 'tasks') {
        renderTasksPage();
    }
}


function handleAddSurvey(e) {
    e.preventDefault();
    const project = projects.find(p => p.id === state.currentProjectId);
    project.survey.status = 'Complete';
    project.survey.data = {
        satisfaction: parseInt(document.getElementById('satisfaction').value),
        feedback: document.getElementById('feedback').value,
    };
    logActivity(project.id, 'Participant survey completed.');
    if (project.status === 'Data Collection') {
        project.status = 'Complete';
    }
    closeModal('survey-modal');
    updateProjectDetailView('detail'); // Refresh the detail tab
}

function sendSurvey(projectId) {
    const project = projects.find(p => p.id === projectId);
    project.survey.status = 'Pending';
    logActivity(projectId, 'Participant survey sent to landowner.');
    updateProjectDetailView('detail'); // Refresh the detail tab
}

function logActivity(projectId, activity, teamMember = 'Helen (Team Coordinator)') {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;
    
    const now = new Date();
    const date = now.toISOString().slice(0, 10);
    const time = now.toLocaleTimeString('en-IE', { hour: '2-digit', minute: '2-digit' });
    
    // 1. Log to project-specific log
    project.activityLog.unshift({
        date: date,
        activity: activity,
    });
    
    // 2. Log to global audit trail
    globalAuditLog.unshift({
        landowner: project.landowner,
        change: activity,
        date: date,
        time: time,
        teamMember: teamMember
    });
    
    // 3. Refresh audit trail if visible
    if (state.currentView === 'auditTrail') {
        renderAuditTrailPage();
    }
}

// New generic logger for non-project events
function logSystemActivity(change, landowner = 'System', teamMember = 'Helen (Team Coordinator)') {
    const now = new Date();
    const date = now.toISOString().slice(0, 10);
    const time = now.toLocaleTimeString('en-IE', { hour: '2-digit', minute: '2-digit' });

    globalAuditLog.unshift({
        landowner: landowner,
        change: change,
        date: date,
        time: time,
        teamMember: teamMember
    });
    
    showToast(change);

    // Refresh audit trail if visible
    if (state.currentView === 'auditTrail') {
        renderAuditTrailPage();
    }
}

// New handler for approving scorecards
function approveScorecard(templateId, templateName) {
    logSystemActivity(`Scorecard '${templateName}' structure approved.`);
    renderSurveysPage(); // Go back to list
}

// New handler for logging action changes
function logGenericAction(actionName, newStatus) {
    const project = projects.find(p => p.id === state.currentProjectId);
    if (!project) return;
    const change = `Action '${actionName}' status changed to '${newStatus}'.`;
    logActivity(project.id, change);
    
    // Update the UI
    const action = project.actions.find(a => a.name === actionName);
    if (action) action.status = newStatus;
    updateProjectDetailView('actions');
    showToast(change);
}


function navigateToProject(projectId, defaultTab = 'detail') {
    renderProjectDetail(projectId, defaultTab);
}

function navigateToDashboard() {
    renderDashboard();
}

// --- HANDLER FUNCTIONS ---
function handleLogin(e) {
    if(e) e.preventDefault();
    // In a real app, you'd validate credentials here
    console.log('Login successful');
    loginPage.classList.add('hidden');
    appContainer.classList.remove('hidden');
    // Initialize the app by rendering the home page
    renderOverviewPage();
}

function handleLogout() {
    // This is a quick "fix" for the prototype to show login again
    // A real app would clear session, etc.
    appContainer.classList.add('hidden');
    loginPage.classList.remove('hidden');
    // Optional: Clear password field for security
    document.getElementById('password').value = "";
}

// --- EVENT LISTENERS ---
homeLink.addEventListener('click', (e) => { e.preventDefault(); renderOverviewPage(); });
dashboardLink.addEventListener('click', (e) => { e.preventDefault(); navigateToDashboard(); });
surveysLink.addEventListener('click', (e) => { e.preventDefault(); renderSurveysPage(); });
tasksLink.addEventListener('click', (e) => { e.preventDefault(); renderTasksPage(); });
plansLink.addEventListener('click', (e) => { e.preventDefault(); renderPlansListPage(); });
auditTrailLink.addEventListener('click', (e) => { e.preventDefault(); renderAuditTrailPage(); });
settingsLink.addEventListener('click', (e) => { e.preventDefault(); renderSettingsPage(); });

addProjectBtn.addEventListener('click', openNewProjectModal);
addTaskBtn.addEventListener('click', () => openNewTaskModal('Site Visit')); // New task button handler

searchInput.addEventListener('keyup', (e) => {
    state.filterText = e.target.value;
    if (state.currentView === 'plansList') {
        renderPlansListPage();
    }
});

// Event delegation for dynamically added elements
contentArea.addEventListener('click', (e) => {
    // Check for dashboard tab clicks (no longer used, but safe to keep)
    const tabBtn = e.target.closest('.dashboard-tab');
    if (tabBtn) {
        e.preventDefault();
        // updateDashboardView(tabBtn.dataset.view); // This function is no longer called
    }

    // Check for project detail tab clicks
    const projectTabBtn = e.target.closest('.project-detail-tab');
    if (projectTabBtn) {
        e.preventDefault();
        updateProjectDetailView(projectTabBtn.dataset.view);
    }
    
    // Check for settings tab clicks
    const settingsTabBtn = e.target.closest('.settings-tab');
    if (settingsTabBtn) {
        e.preventDefault();
        updateSettingsView(settingsTabBtn.dataset.view);
    }
});

// Communication sidebar links
communicationLink.addEventListener('click', (e) => {
    e.preventDefault();
    // Defaults to 'county' filter, can be changed to a general comms page
    openCommunicationModal('county');
});

// Team Members sidebar links
teamLink.addEventListener('click', (e) => {
    e.preventDefault();
    renderTeamMembers();
});

// --- NEW LOGIN LISTENERS ---
logoutBtn.addEventListener('click', handleLogout); // Logout button now works

// Sidebar collapsible sections - MODIFIED FOR EVENT DELEGATION
document.body.addEventListener('click', (e) => {
    const button = e.target.closest('.collapsible-btn');
    if (button) {
        const content = button.nextElementSibling;
        const icon = button.querySelector('i.fa-chevron-down');
        if (content && icon) {
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
    }
});

// Close modals with Escape key
window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeModal('new-project-modal');
        closeModal('assessment-modal');
        closeModal('survey-modal');
        closeModal('communication-modal');
        closeModal('new-task-modal');
    }
});

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Generate mock data on load
    generateMockAuditLogs();
    
    // --- MODIFICATION: Skip login for prototype ---
    console.log('Skipping login, loading app directly.');
    // We just call handleLogin directly without an event
    handleLogin(); 
    // --- END MODIFICATION ---
    
    // Original login listener (disabled)
    // loginForm.addEventListener('submit', handleLogin);
});

    </script>
</body>

</html>
